stages:
  - tests
  - wheels
  - staging
  - merge


workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    - if: '$CI_COMMIT_BRANCH'

.tests: &tests
  stage: tests
  script:
    - pip install -e .[all]
    - pytest

#tests_python_36:
#  <<: *tests
#  image: diefans/python3.6-alpine-cython:0.1.0

tests_python_37:
  <<: *tests
  image: diefans/python3.7-alpine-cython:0.1.0

# failing: https://github.com/Tinche/cattrs/issues/46
tests_python_38:
  <<: *tests
  image: diefans/python3.8-alpine-cython:0.1.0

tests_python_39:
  <<: *tests
  image: diefans/python3.9-alpine-cython:0.2.0

.wheels: &wheels
  stage: wheels
  image: quay.io/pypa/manylinux2014_x86_64
  script:
    #- mkdir ./dist
    - ./build_manylinux.sh
    #- cp ./wheelhouse/buvar* ./dist
  artifacts:
    when: on_success
    paths:
      - dist
    expire_in: 30 mins

wheels_python39_x86_64:
  <<: *wheels
  needs: [tests_python_39]
  variables:
    PLATFORM: manylinux2014_x86_64
    PYTHON_VERSIONS: cp39-cp39

wheels_python38_x86_64:
  <<: *wheels
  needs: [tests_python_38]
  variables:
    PLATFORM: manylinux2014_x86_64
    PYTHON_VERSIONS: cp38-cp38

wheels_python37_x86_64:
  <<: *wheels
  needs: [tests_python_37]
  variables:
    PLATFORM: manylinux2014_x86_64
    PYTHON_VERSIONS: cp37-cp37m

merge_request:
  stage: staging
  needs: [tests_python_37, tests_python_38, tests_python_39]
  script:
      # setup ssh
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$SSH_PRIVATE_KEY")

      # fix url
    - REPOSITORY_URL=$(echo $CI_REPOSITORY_URL | sed -r s,.+@([^/]+)/,git@\\1:,)
    - git remote set-url --push origin ${REPOSITORY_URL}

      # merge into staging
    - git checkout -B staging/${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}
    - git merge origin/master
    - git push -u origin staging/${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}
  only:
    - merge_requests


merge:
  stage: merge
  only:
    - staging
  needs: [merge_request]
  script:
      # setup ssh
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$SSH_PRIVATE_KEY")

      # fix url
    - REPOSITORY_URL=$(echo $CI_REPOSITORY_URL | sed -r s,.+@([^/]+)/,git@\\1:,)
    - git remote set-url --push origin ${REPOSITORY_URL}
